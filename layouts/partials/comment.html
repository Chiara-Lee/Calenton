<div class="comments">
  <h2>Comments</h2>
  {{$comments := dict}}
  {{ if getenv "NETLIFY" }}
    {{$comments = partialCached "netlifyCommentList.html" .}}
  {{ else }}
    {{$comments = partialCached "formspreeCommentList.html" .}}
  {{ end }}

  <!-- 递归显示评论结构 -->
  {{ range (index $comments .RelPermalink) }}
    {{ partial "comment_recursion.html" (dict "comment" . "Depth" 0) }}
  {{ end }}
  
  {{ if .Disabled }}
    <div>
      Comments have been disabled by the website administrator.
    </div>
  {{ else }}

    <template id="comment-success">
      <div class="success">
        {{ default "您的评论已成功提交审核。(´｡• ᵕ •｡`)" (site.Param "comment-success") }}
      </div>
    </template>
    <template id="comment-error">
      <div class="error">
        {{ default "啊，好像出了些问题，请您调整后重试。(；′⌒`)" (site.Param "comment-error") }}
      </div>
    </template>

    <form id="comment-form" data-dynamic-form data-success="#comment-success" data-error="#comment-error" netlify="true" name="Comments">
  
      <div id="reply-to" style="display: none; color: #6c757d; margin-bottom: 10px;"></div> <!-- 用于显示回复对象 -->
      
      <input type="hidden" name="url" value="{{ .RelPermalink }}">
      <input type="hidden" name="comment_id" id="comment-id" value="">
      <input type="hidden" name="parent" id="parent" value="">
      
      <label class="comment-label" for="name">Name:</label>
      <input class="comment-input" type="text" id="name" name="name" required autocomplete="name">
      
      <label class="comment-label" for="email">Email:</label>
      <input class="comment-input" type="email" id="email" name="email" required autocomplete="email">
      
      <label class="comment-label" for="comment">Comment:</label>
      <textarea class="comment-textarea" id="comment" name="comment" rows="5" required autocomplete="off"></textarea>
      
      <button class="comment-button" type="submit">Send</button>
    </form>
    
  {{ end }}
</div>
<script>
  // 生成 Base64 ID 的函数
  function generateBase64Id() {
    const timestamp = Date.now().toString();
    const randomNum = Math.floor(Math.random() * 1000000).toString();
    const base64Id = btoa(timestamp + randomNum);
    return base64Id;
  }
  
  // 页面加载时为评论生成唯一 ID
  document.addEventListener("DOMContentLoaded", function() {
    const commentIdField = document.getElementById("comment-id");
    if (commentIdField) {
      commentIdField.value = generateBase64Id();  // 设置评论的唯一 ID
    }
  });
  
  // 回复按钮逻辑
  document.querySelectorAll(".reply-button").forEach(button => {
    button.addEventListener("click", function() {
      const parentId = this.getAttribute("data-parent");
      document.getElementById("parent").value = parentId;  // 设置 parent_id
    });
  });
  </script>


