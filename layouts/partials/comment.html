<div class="comments">
  <h2>Comments</h2>
  {{$comments := dict}}
  {{ if getenv "NETLIFY" }}
    {{$comments = partialCached "netlifyCommentList.html" .}}
  {{ else }}
    {{$comments = partialCached "formspreeCommentList.html" .}}
  {{ end }}


 <!-- 确保每个评论对象都有所需的字段 s-->
 {{ $normalizedComments := slice }}
 {{ range $index, $comment := $comments }}
   {{ $uniqueId := (printf "%d" (now.UnixNano)) }}
   {{ $commentId := default "unknown" $comment.custom_id }}
   {{ $normalizedComment := dict 
    "custom_id" $commentId
     "parent" (default "" $comment.parent) 
     "name" (default "" $comment.name) 
     "email" (default "" $comment.email) 
     "comment" (default "" $comment.comment) 
     "time" (default "" $comment.time) 
   }}
   {{ $normalizedComments = $normalizedComments | append $normalizedComment }}
 {{ end }}

 <!-- 渲染顶级评论 -->
 {{ range $index, $comment := $normalizedComments }}
 {{ if eq $comment.parent "" }} <!-- 判断顶级评论，parent 为空字符串 -->
   {{ partial "comment_recursion.html" (dict "comment" $comment "Depth" 0 "comments" $normalizedComments) }}
 {{ end }}
{{ end }}

  
  {{ if .Disabled }}
    <div>
      Comments have been disabled by the website administrator.
    </div>
  {{ else }}

    <template id="comment-success">
      <div class="success">
        {{ default "您的评论已成功提交审核。(´｡• ᵕ •｡`)" (site.Param "comment-success") }}
      </div>
    </template>
    <template id="comment-error">
      <div class="error">
        {{ default "啊，好像出了些问题，请您调整后重试。(；′⌒`)" (site.Param "comment-error") }}
      </div>
    </template>

    <form id="comment-form" data-dynamic-form data-success="#comment-success" data-error="#comment-error" netlify="true" name="Comments">
  
      <div id="reply-to" style="display: none; color: #6c757d; margin-bottom: 10px;"></div> <!-- 用于显示回复对象 -->
      
      <input type="hidden" name="url" value="{{ .RelPermalink }}">
      <input type="hidden" name="custom_id" id="custom-id" value="{{ printf "%d" (now.UnixNano) }}">
      <input type="hidden" name="parent" id="parent" value="">
      
      <label class="comment-label" for="name">Name:</label>
      <input class="comment-input" type="text" id="name" name="name" required autocomplete="name">
      
      <label class="comment-label" for="email">Email:</label>
      <input class="comment-input" type="email" id="email" name="email" required autocomplete="email">
      
      <label class="comment-label" for="comment">Comment:</label>
      <textarea class="comment-textarea" id="comment" name="comment" rows="5" required autocomplete="off"></textarea>
      
      <button class="comment-button" type="submit">Send</button>
    </form>
    
  {{ end }}
</div>
<script>
  
  // 点击 "Reply" 按钮时为子评论设置父评论的 ID
  document.querySelectorAll(".reply-button").forEach(button => {
    button.addEventListener("click", function() {
      const uniqueId = generateUUID(); // 为新评论生成唯一 ID
      document.getElementById("custom-id").value = uniqueId;

      // 获取并设置父评论的 ID
      const parentId = this.getAttribute("data-parent");
      document.getElementById("parent").value = parentId || ""; // 确保 parent 字段有值
    })
  });  
   
  
  //添加 JavaScript 脚本来处理回复按钮
  document.querySelectorAll('.reply-button').forEach(button => {
  button.addEventListener('click', function() {
    const parentId = this.getAttribute('data-parent');
    const parentName = this.getAttribute('data-name'); // 获取评论者的名字
    document.getElementById('parent').value = parentId || ""; // 为子评论添加父评论值，确保有值
    console.log("Parent ID set to:", parentId);  // 检查是否正确设置了 parent ID
    document.getElementById('reply-to').style.display = 'block'; // 显示回复对象的提示
    document.getElementById('reply-to').innerText = `回复 @${parentName}`; // 设置显示内容
    document.getElementById('comment-form').scrollIntoView({ behavior: 'smooth' }); // 平滑滚动至表单
  });
});

  // 表单提交前为新评论生成唯一 ID
  document.getElementById("comment-form").addEventListener("submit", function(event) {
    const commentIdField = document.getElementById("custom-id");
    if (commentIdField) {
      // 使用新的基于 Hugo 的生成逻辑,基于时间戳生成的唯一 ID
      const uniqueId = `${Date.now()}-${Math.floor(Math.random() * 1000)}`;
      commentIdField.value = uniqueId; // 为提交的评论分配唯一 ID
    }
  });
  function REMOVE_FORM_ON_SUBMISSION() {
    // 清除输入字段内容
    document.getElementById("comment-form").reset();
    console.log("Form has been cleared after submission.");
  }

  </script>


